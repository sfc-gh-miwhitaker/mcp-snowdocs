name: Demo Expiration Check

on:
  schedule:
    # Run daily at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      administration: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read expiration date from deploy_all.sql
        id: read_expiry
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "deploy_all.sql" ]; then
            echo "deploy_all.sql not found in repo root"
            exit 1
          fi

          EXPIRY_DATE="$(grep -E '^[[:space:]]*\*[[:space:]]*EXPIRES:[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}[[:space:]]*$' deploy_all.sql | head -n 1 | sed -E 's/.*EXPIRES:[[:space:]]*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')"

          if [ -z "${EXPIRY_DATE}" ]; then
            echo "Failed to parse EXPIRES: YYYY-MM-DD from deploy_all.sql header"
            exit 1
          fi

          echo "expiry_date=${EXPIRY_DATE}" >> "${GITHUB_OUTPUT}"

      - name: Check expiration date
        id: check
        run: |
          EXPIRY_DATE="${{ steps.read_expiry.outputs.expiry_date }}"
          CURRENT_DATE=$(date +%Y-%m-%d)

          echo "Current date: $CURRENT_DATE"
          echo "Expiry date: $EXPIRY_DATE"

          if [[ "$CURRENT_DATE" > "$EXPIRY_DATE" ]]; then
            echo "status=expired" >> $GITHUB_OUTPUT
            echo "Demo expired on $EXPIRY_DATE"
          else
            echo "status=active" >> $GITHUB_OUTPUT
            DAYS_LEFT=$(( ( $(date -d "$EXPIRY_DATE" +%s) - $(date -d "$CURRENT_DATE" +%s) ) / 86400 ))
            echo "Demo active - $DAYS_LEFT days remaining until $EXPIRY_DATE"
          fi

      - name: Create expiration issue
        if: steps.check.outputs.status == 'expired'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'demo-expired'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Demo expired - archive required',
                body: `## Demo Expiration Notice

                This demonstration project expired on **${{ steps.read_expiry.outputs.expiry_date }}**.

                ### Required Actions:
                1. Archive this repository
                2. Make repository private
                3. Update internal documentation with new demo location

                ### Context:
                - **Purpose:** Prevent users from discovering stale demos with outdated Snowflake syntax
                - **Policy:** All public demos must have 30-day expiration (core.mdc rules)
                - **Next Steps:** Update \`deploy_all.sql\` (single source of truth) and \`README.md\` if this repo needs to remain active

                This issue was automatically created by the demo expiration workflow.
                `,
                labels: ['demo-expired', 'action-required']
              });
            }

      - name: Archive repository when expired (best effort)
        if: steps.check.outputs.status == 'expired'
        uses: actions/github-script@v7
        env:
          MASTER_PAT: ${{ secrets.MASTER_PAT }}
        with:
          github-token: ${{ secrets.MASTER_PAT || github.token }}
          script: |
            try {
              await github.rest.repos.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                archived: true
              });
              core.info('Repository archived.');
            } catch (e) {
              core.warning(`Failed to archive repository. You may need elevated permissions. Error: ${e.message}`);
            }
